<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<!--[if lt IE 9]>
<script type="text/javascript" src="lib/html5.js"></script>
<script type="text/javascript" src="lib/respond.min.js"></script>
<script type="text/javascript" src="lib/PIE_IE678.js"></script>
<![endif]-->
<link href="__CSS__/H-ui.min.css" rel="stylesheet" type="text/css" />
<link href="__CSS__/H-ui.admin.css" rel="stylesheet" type="text/css" />
<link href="__CSS__/H-style.css" rel="stylesheet" type="text/css" />
<link href="__CSS__/lib/Hui-iconfont/1.0.1/iconfont.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="__CSS__/lib/zTree/v3/css/zTreeStyle/zTreeStyle.css" type="text/css">
<!--[if IE 6]>
<script type="text/javascript" src="http://lib.h-ui.net/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script>
<![endif]-->

<style type="text/css">
li{
	list-style: none;
	
}

.dropdown{
	float: left;
	width: 60px;
	position: relative;
}
.dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    padding: 10px 0;
    border-radius: 4px;
    border: 1px solid #ccd0d7;
    box-shadow: 2px 2px 4px rgba(0,0,0,.2);
    background: #fff;
} 

.cover-box {
    width: 160px;
    height: 100px;
    cursor: pointer;
    margin-bottom: 20px;
    background-repeat: no-repeat;
    background-size: cover;
    position: relative;
    overflow: hidden;
    top: 254px;
    left: 210px;
    border: 1px solid #ccc;
}


.cover-preview
{
	width: 160px;
    height: 100px;
}
.cover-wrp .cover-box .cover-mask, .cover-wrp .cover-box img {
    width: 100%;
    height: 100%;
    border-radius: 4px;
}
</style>


<title>视频列表</title>
</head>
<body class="pos-r">
<div class="pos-a" style="width:150px;left:0;top:0; bottom:0; height:100%; border-right:1px solid #e5e5e5; background-color:#f5f5f5">
	<a class="btn btn-primary radius" onclick="genjiedian()" href="javascript:;"><i class="Hui-iconfont">&#xe600;</i> 添加根节点</a>
	<ul id="treeDemo" class="ztree">
	</ul>
	<!-- <select id="menu" name="slect" class="ztree" style="margin-top: 20px;margin-left: 20px">
		</select> -->
</div>
<!-- <td class="va-t"><IFRAME  ID="testIframe"Name="testIframe" FRAMEBORDER=0 SCROLLING=AUTO width=100% height=390px SRC="{:url('admin/adminuser/product_category_add')}"></IFRAME></td> -->
<div style="margin-left:150px;">
	<nav class="breadcrumb"><i class="Hui-iconfont">&#xe67f;</i> 首页 <span class="c-gray en">&gt;</span> 视频管理 <span class="c-gray en">&gt;</span> 视频列表 <a class="btn btn-success radius r mr-20" style="line-height:1.6em;margin-top:3px" href="javascript:location.replace(location.href);" title="刷新" ><i class="Hui-iconfont">&#xe68f;</i></a></nav>
	<div class="pd-20">
		
		<div class="cl pd-5 bg-1 bk-gray mt-20"> <span class="l"><!-- <a href="javascript:;" onclick="datadel()" class="btn btn-danger radius"><i class="Hui-iconfont">&#xe6e2;</i> 批量删除</a> --> <a class="btn btn-primary radius" onclick="product_add('添加视频','product_add.html')" href="javascript:;"><i class="Hui-iconfont">&#xe600;</i> 上传视频</a></span> <span class="r"> </div>
		<div class="mt-20">

			<table id="myTb" class="table table-border table-bordered table-bg table-hover table-sort">
				<thead>
					<tr class="text-c">
						<th width="40"><input name="" type="checkbox" value=""></th>
						<th width="40">ID</th>
						<!-- <th width="60">缩略图</th> -->
						<th width="100">视频名称</th>
						<!-- <th>描述</th>
						<th width="100">单价</th>
						<th width="60">发布状态</th>-->
						<th width="100">操作</th> 
					</tr>
				</thead>
				
			</table>


		</div>
	</div>
</div>

<script type="text/javascript" src="__CSS__/lib/jquery/1.9.1/jquery.min.js"></script> 
<script type="text/javascript" src="__CSS__/lib/layer/1.9.3/layer.js"></script>
<script type="text/javascript" src="__CSS__/lib/My97DatePicker/WdatePicker.js"></script> 
<script type="text/javascript" src="__CSS__/lib/datatables/1.10.0/jquery.dataTables.min.js"></script> 
<script type="text/javascript" src="__CSS__/lib/zTree/v3/js/jquery.ztree.all-3.5.min.js"></script> 
<script type="text/javascript" src="__JS__/H-ui.js"></script> 
<script type="text/javascript" src="__JS__/H-ui.admin.js"></script> 
<script type="text/javascript">
//zTreeStyle.css
var setting = {
	 async: {
                enable: true,//开启异步加载处理
                //dataFilter: filter//用于对 Ajax 返回数据进行预处理的函数
          },
	view: {
		dblClickExpand: false,
		showLine: false,
		selectedMulti: false,
		addHoverDom: addHoverDom,
		//用于当鼠标移动到节点上时，显示用户自定义控件，显示隐藏状态同 zTree 内部的编辑、删除按钮
        removeHoverDom: removeHoverDom,//设置鼠标移到节点上，在后面显示一个按钮
		
	},
	 edit: {
                enable: true,//设置 zTree 进入编辑状态
                removeTitle: "删除节点",
				renameTitle: "编辑节点名称"

           },
	data: {
		simpleData: {
			enable:true,
			idKey: "id",
			pIdKey: "pid",
			rootPId: ""
		}
	},	
	callback: {
		beforeClick: function(treeId, treeNode) {
				// alert(1);
			var zTree = $.fn.zTree.getZTreeObj("tree");
			

			if (treeNode.isParent) {
				//alert(2);
				// zTree.expandNode(treeNode);
				return false;
			} else {
				// alert(3);
				 //demoIframe.attr('<a href='+product_category_add+'?tid='+treeNode.id+'></a>');
				  $.ajax({
				 "url":"{:url('admin/adminuser/product_category_addd')}",
				 type: 'post',
				 
				 dataType: 'json',
				data:{
					"tid":treeNode.id,
					
				},
				 success: function(res) {
				 	if(res[0]){
					 		$.each(res , function(i,n){
	       					if(n.recovery==1){
	       						var tbody;
	       					//alert(n.vid);
	       				
	       					tbody+="<tr class='text-c va-m'><td><input name='check'type='checkbox'value="+n.vid+"</td><td>"+n.vid+"</td><td>"+n.title+"</td><td><a style='text-decoration:none' onClick='product_stop(this,"+n.vid+")' href='javascript:;' title='下架'><i class='Hui-iconfont'>&#xe6de;</i></a><a style='text-decoration:none' class='ml-5' onClick='product_edit('产品编辑','product_add.html','10001')' href='javascript:;' title='编辑'><i class='Hui-iconfont'>&#xe6df;</i></a><a style='text-decoration:none' class='ml-5' onClick='product_del(this,"+n.vid+")' href='javascript:;' title='删除'><i class='Hui-iconfont'>&#xe6e2;</i></a>"+"</td></tr>"
	       					// //alert(trbody);
	       					//  //$("#myTb").text('');
	      					 $("#myTb").append(tbody);
	       					}else{
					 		layer.msg('没有数据');
					 		
					 		}
	       					
	       				});
					 	}else{
					 		layer.msg('没有数据');
					 		
					 	}
				 	
				
				 }
		 	});
					
				return true;
			}
		},
		  beforeRename: beforeRename, //用于捕获节点编辑名称结束回调函数
		  beforeRemove: beforeRemove //用于捕获节点被删除之前的事件回调函数，并且根据返回值确定是否允许删除操作
	}
};


		
var code;
		
function showCode(str) {
	if (!code) code = $("#code");
	code.empty();
	code.append("<li>"+str+"</li>");
}



  //修改节点信息
    function beforeRename(treeId, treeNode, newName) {
            if (newName.length == 0) {
                layer.confirm("节点名称不能为空.");
                return false;
            }
            var treeInfo = treeNode.id;
            $.ajax({
				 "url":"{:url('admin/adminuser/xiugai_type')}",
				 type: 'post',
				 dataType: 'json',
				data:{
					"tid":treeInfo,
					"newname":newName
				},
				 success: function(res) {
				 	if(res.status){
				 		//alert(res.msg);
				 		layer.msg(res.msg);
				 		 //window.location.reload();
				 	}else{
				 		layer.msg(res.msg);
				 	}
				
				 }
		 	});
    }	
  //删除节点信息
        function beforeRemove(treeId, treeNode) {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo");
            zTree.selectNode(treeNode);
             if(treeNode.isParent){  
			        //toastr.warning("请先删除子节点"); 
			        layer.confirm("请先删除子节点") ;

			        return false;  
			    } 
            if (confirm("确认删除 节点 -- " + treeNode.name + " 吗？")) {

                var treeInfo = treeNode.id;
	                $.ajax({
						 "url":"{:url('admin/adminuser/del_type')}",
						 type: 'post',
						 dataType: 'json',
						data:{
							"tid":treeInfo
							
						},
						 success: function(res) {
						 	if(res.status){
						 		layer.msg(res.msg);
						 		
						 	}else{
						 		layer.msg(res.msg);
						 	}
						
						 }
			 		});
            } else {
                window.location.reload();
            }
        }

// 添加子部门操作  
var newCount = 0;  
function addHoverDom(treeId, treeNode) {  
    var sObj = $("#" + treeNode.tId + "_span");  
    if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;  
    var addStr = "<span class='button add' id='addBtn_" + treeNode.tId  
        + "' title='添加' onfocus='this.blur();'></span>";  
    sObj.after(addStr);  
    var btn = $("#addBtn_"+treeNode.tId);  
    //var isAdded=false;  
    if (btn) btn.bind("click", function(){  
        newCount++;  
        $.ajax({  
            type : "POST",    
          
            url : "{:url('admin/adminuser/add_type')}",    
            data :    
            {    
                "name" : "新部门"+newCount,  
                "parentId":treeNode.id  
            },  
            success:function(result){  
                if(""!=result ){  
                	
                    var zTree = $.fn.zTree.getZTreeObj("treeDemo");  
                    zTree.addNodes(treeNode, {id:result, parentId:treeNode.id, name:"新部门"+newCount});  

                    window.location.reload();  
                }else{  
                    layer.msg("无法添加新部门，请联系管理员！");  
                }  
            }  
        });   
        return false;             
    });  
};  
//添加根节点
var count=0;
function genjiedian()
{
	count++;
	 $.ajax({  
            type : "POST",    
          
            url : "{:url('admin/adminuser/add_gen')}",    
            data :    
            {    
                "name" : "新部门"+count,  
               
            },  
            success:function(result){  
                  if(""!=result ){  
                  
                    var zTree = $.fn.zTree.getZTreeObj("treeDemo");  
                   
                    zTree.addNodes({id:result, parentId:'0', name:"新部门"+count});  
                    window.location.reload();
                    return false;  
                }else{  
                    layer.msg("无法添加新部门，请联系管理员！");  
                }  
            }  
        });   
}
function removeHoverDom(treeId, treeNode) {  
    $("#addBtn_"+treeNode.tId).unbind().remove();  
};  


$(document).ready(function(){
	var zNodes =new Array();
	 $.ajax({
		 "url":"{:url('admin/adminuser/jsonlist')}",
		 type: 'post',
		 dataType: 'json',
		
		 success: function(res) {
		 zNodes=res['data'];				
		// alert(zNodes);
		 $.fn.zTree.init($("#treeDemo"), setting, zNodes);
		 console.log(res['data']);
		 }
 	});


	demoIframe = $("#testIframe");
	// demoIframe.bind("load", loadReady);
	var zTree = $.fn.zTree.getZTreeObj("tree");

});



$('.table-sort').dataTable({
	"aaSorting": [[ 1, "desc" ]],//默认第几个排序
	"bStateSave": true,//状态保存
	"aoColumnDefs": [
	  {"orderable":false,"aTargets":[0,7]}// 制定列不参与排序
	]
});
/*图片-添加*/
function product_add(title,url){
	var index = layer.open({
		type: 2,
		title: title,
		content: url
	});
	layer.full(index);
}
/*图片-查看*/
function product_show(title,url,id){
	var index = layer.open({
		type: 2,
		title: title,
		content: url
	});
	layer.full(index);
}
/*图片-审核*/
function product_shenhe(obj,id){
	layer.confirm('审核文章？', {
		btn: ['通过','不通过'], 
		shade: false
	},
	function(){
		$(obj).parents("tr").find(".td-manage").prepend('<a class="c-primary" onClick="product_start(this,id)" href="javascript:;" title="申请上线">申请上线</a>');
		$(obj).parents("tr").find(".td-status").html('<span class="label label-success radius">已发布</span>');
		$(obj).remove();
		layer.msg('已发布', {icon:6,time:1000});
	},
	function(){
		$(obj).parents("tr").find(".td-manage").prepend('<a class="c-primary" onClick="product_shenqing(this,id)" href="javascript:;" title="申请上线">申请上线</a>');
		$(obj).parents("tr").find(".td-status").html('<span class="label label-danger radius">未通过</span>');
		$(obj).remove();
    	layer.msg('未通过', {icon:5,time:1000});
	});	
}
/*图片-下架*/
function product_stop(obj,id){
	layer.confirm('确认要下架吗？',function(index){
		$(obj).parents("tr").find(".td-manage").prepend('<a style="text-decoration:none" onClick="product_start(this,id)" href="javascript:;" title="发布"><i class="Hui-iconfont">&#xe603;</i></a>');
		$(obj).parents("tr").find(".td-status").html('<span class="label label-defaunt radius">已下架</span>');
		$(obj).remove();
		layer.msg('已下架!',{icon: 5,time:1000});
	});
}

/*图片-发布*/
function product_start(obj,id){
	layer.confirm('确认要发布吗？',function(index){
		$(obj).parents("tr").find(".td-manage").prepend('<a style="text-decoration:none" onClick="product_stop(this,id)" href="javascript:;" title="下架"><i class="Hui-iconfont">&#xe6de;</i></a>');
		$(obj).parents("tr").find(".td-status").html('<span class="label label-success radius">已发布</span>');
		$(obj).remove();
		layer.msg('已发布!',{icon: 6,time:1000});
	});
}
/*图片-申请上线*/
function product_shenqing(obj,id){
	$(obj).parents("tr").find(".td-status").html('<span class="label label-default radius">待审核</span>');
	$(obj).parents("tr").find(".td-manage").html("");
	layer.msg('已提交申请，耐心等待审核!', {icon: 1,time:2000});
}
/*图片-编辑*/
function product_edit(title,url,id){
	var index = layer.open({
		type: 2,
		title: title,
		content: url
	});
	layer.full(index);
}
/*图片-删除*/
function product_del(obj,id){
	// layer.confirm('确认要删除吗？',function(index){
	// 	$(obj).parents("tr").remove();
	// 	layer.msg('已删除!',{icon:1,time:1000});
	// });
	layer.msg('你确定删除么？', {
    time: 0 //不自动关闭
    ,btn: ['确定', '取消']
    ,yes: function(index){
        //alert(1);
        $.ajax({
            url:"{:url('admin/adminuser/videohuishou')}",
            data:{'id':id},
            type:"Post",
            dataType:"json",
            success:function(data){
            	//实现了为删除
            	$(obj).parents("tr").remove();
                layer.msg(data.msg);
            },
            error:function(data){
                $.messager.alert('错误',data.msg);
            }
        });
        layer.close(index);

    	}
	});
}
</script>
</body>
</html>